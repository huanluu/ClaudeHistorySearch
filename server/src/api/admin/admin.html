<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude History Server — Control Panel</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0b0d14;
    --surface: #151922;
    --card-bg: #181d2a;
    --sidebar-bg: #0e1019;
    --border: rgba(255, 255, 255, 0.06);
    --border-hover: rgba(255, 255, 255, 0.12);
    --text: #e8eaef;
    --text-secondary: #8890a8;
    --text-dim: #555d78;
    --accent: #f0b429;
    --accent-soft: rgba(240, 180, 41, 0.12);
    --cyan: #5eead4;
    --cyan-soft: rgba(94, 234, 212, 0.12);
    --rose: #f472b6;
    --rose-soft: rgba(244, 114, 182, 0.12);
    --success: #4ade80;
    --error: #f87171;
    --input-bg: #0e111a;
    --input-border: rgba(255, 255, 255, 0.08);
    --font-display: 'Syne', system-ui, sans-serif;
    --font-body: 'Outfit', system-ui, sans-serif;
    --font-mono: 'JetBrains Mono', ui-monospace, monospace;
    --radius: 12px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --ease: cubic-bezier(0.4, 0, 0.2, 1);
    --sidebar-w: 260px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 40% 0%, rgba(240, 180, 41, 0.04) 0%, transparent 60%),
      radial-gradient(ellipse 50% 40% at 90% 100%, rgba(94, 234, 212, 0.03) 0%, transparent 60%);
    pointer-events: none;
  }

  /* ── Accent bar ── */
  .accent-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--cyan), var(--rose), #a78bfa, var(--accent));
    background-size: 400% 100%;
    animation: shimmer 12s linear infinite;
    z-index: 1000;
  }
  @keyframes shimmer {
    0% { background-position: 0% 50%; }
    100% { background-position: 400% 50%; }
  }

  /* ── Sidebar ── */
  .sidebar {
    position: fixed;
    top: 3px; left: 0; bottom: 0;
    width: var(--sidebar-w);
    background: var(--sidebar-bg);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    overflow-y: auto;
  }
  .sidebar-brand {
    padding: 2rem 1.5rem 1.5rem;
  }
  .sidebar-brand h1 {
    font-family: var(--font-display);
    font-size: 1.15rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    line-height: 1.3;
  }
  .sidebar-brand .badge {
    display: inline-block;
    font-size: 0.62rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    background: rgba(255, 255, 255, 0.04);
    padding: 0.15rem 0.55rem;
    border-radius: 100px;
    border: 1px solid var(--border);
    margin-top: 0.5rem;
  }

  .sidebar-nav {
    flex: 1;
    padding: 0 0.75rem;
  }
  .nav-section {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    padding: 0.5rem 0.75rem 0.4rem;
    margin-top: 0.5rem;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    padding: 0.55rem 0.75rem;
    border-radius: var(--radius-xs);
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--text-secondary);
    cursor: pointer;
    transition: background 0.15s var(--ease), color 0.15s var(--ease);
    text-decoration: none;
    position: relative;
  }
  .nav-item:hover {
    background: rgba(255, 255, 255, 0.04);
    color: var(--text);
  }
  .nav-item.active {
    background: rgba(255, 255, 255, 0.06);
    color: var(--text);
  }
  .nav-item.active::before {
    content: '';
    position: absolute;
    left: 0; top: 8px; bottom: 8px;
    width: 3px;
    border-radius: 0 3px 3px 0;
    background: var(--nav-color, var(--accent));
  }
  .nav-item svg {
    width: 18px; height: 18px;
    flex-shrink: 0;
    opacity: 0.6;
  }
  .nav-item.active svg { opacity: 1; }
  .nav-item.disabled {
    opacity: 0.35;
    cursor: default;
    pointer-events: none;
  }
  .nav-item .coming-soon {
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-dim);
    background: rgba(255, 255, 255, 0.04);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    margin-left: auto;
  }

  .sidebar-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid var(--border);
  }
  .server-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .pulse-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
    position: relative;
  }
  .pulse-dot.connected {
    background: var(--success);
    box-shadow: 0 0 6px rgba(74, 222, 128, 0.4);
  }
  .pulse-dot.connected::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    border: 1.5px solid var(--success);
    animation: pulse 2.5s ease-in-out infinite;
  }
  .pulse-dot.error { background: var(--error); }
  @keyframes pulse {
    0%, 100% { opacity: 0; transform: scale(0.8); }
    50% { opacity: 0.4; transform: scale(1.3); }
  }

  /* ── Main content ── */
  .main {
    margin-left: var(--sidebar-w);
    min-height: 100vh;
    padding: 2.5rem 3rem 4rem;
  }
  .main-inner {
    max-width: 960px;
  }

  .page-title {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 0.35rem;
  }
  .page-subtitle {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
  }

  /* ── Cards ── */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-left: 3px solid var(--card-accent, var(--border));
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    overflow: hidden;
    transition: border-color 0.2s var(--ease), box-shadow 0.2s var(--ease), opacity 0.3s var(--ease), filter 0.3s var(--ease);
    opacity: 0;
    transform: translateY(14px);
    animation: card-in 0.5s var(--ease) forwards;
    scroll-margin-top: 2rem;
  }
  .card:nth-child(1) { animation-delay: 0.05s; }
  .card:nth-child(2) { animation-delay: 0.1s; }
  .card:nth-child(3) { animation-delay: 0.15s; }
  .card:nth-child(4) { animation-delay: 0.2s; }
  @keyframes card-in {
    to { opacity: 1; transform: translateY(0); }
  }
  .card:hover {
    border-color: var(--border-hover);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
  }
  .card.disabled {
    opacity: 0.3;
    filter: blur(1px) grayscale(0.3);
    pointer-events: none;
  }

  /* Heartbeat fields dimmed when disabled */
  .hb-fields.dimmed {
    opacity: 0.35;
    pointer-events: none;
    transition: opacity 0.25s var(--ease);
  }
  .hb-fields {
    transition: opacity 0.25s var(--ease);
  }

  /* ── Card sections ── */
  .card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.875rem;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .card-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--card-accent, var(--text-dim));
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
  }
  .card-icon::before {
    content: '';
    position: absolute;
    inset: 0;
    background: currentColor;
    opacity: 0.12;
    border-radius: inherit;
  }
  .card-icon svg { position: relative; z-index: 1; }
  .card-header h2 {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.3;
  }
  .card-desc {
    font-size: 0.78rem;
    color: var(--text-secondary);
    margin-top: 0.15rem;
  }
  .card-body { padding: 1.25rem 1.5rem; }
  .card-footer {
    padding: 0 1.5rem 1.25rem;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 0.75rem;
  }

  /* ── Auth status dot ── */
  .auth-title-row { display: flex; align-items: center; gap: 0.5rem; }
  .auth-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
  }
  .auth-dot.loading {
    background: var(--accent);
    animation: blink 1s ease-in-out infinite;
  }
  .auth-dot.ok { background: var(--success); }
  .auth-dot.fail { background: var(--error); }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ── Form elements ── */
  .field { margin-bottom: 1.25rem; }
  .field:last-child { margin-bottom: 0; }
  .field > label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.4rem;
    letter-spacing: 0.01em;
  }
  .hint {
    font-size: 0.72rem;
    color: var(--text-dim);
    margin-top: 0.35rem;
    line-height: 1.45;
  }

  input[type="text"],
  input[type="number"],
  input[type="password"],
  select,
  textarea {
    width: 100%;
    padding: 0.6rem 0.875rem;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: var(--radius-xs);
    color: var(--text);
    font-size: 0.85rem;
    font-family: var(--font-body);
    transition: border-color 0.2s var(--ease), box-shadow 0.2s var(--ease);
    outline: none;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--card-accent, var(--accent));
    box-shadow: 0 0 0 3px var(--card-accent-soft, var(--accent-soft));
  }
  input:disabled, select:disabled, textarea:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .mono-input {
    font-family: var(--font-mono);
    font-size: 0.8rem;
  }

  select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238890a8' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.5rem;
    cursor: pointer;
  }
  select option {
    background: var(--surface);
    color: var(--text);
  }

  textarea {
    resize: vertical;
    min-height: 100px;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    line-height: 1.7;
  }

  .input-group { position: relative; }
  .input-group input { padding-right: 2.75rem; }
  .input-action {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    transition: color 0.2s var(--ease);
  }
  .input-action:hover { color: var(--text-secondary); }

  .field-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
  }

  /* Toggle */
  .toggle-field {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.35rem 0;
  }
  .toggle-label {
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
  }
  .toggle {
    position: relative;
    width: 44px; height: 24px;
    flex-shrink: 0;
  }
  .toggle input {
    opacity: 0; width: 0; height: 0;
    position: absolute;
  }
  .toggle .track {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    cursor: pointer;
    transition: background 0.25s var(--ease);
  }
  .toggle .track::before {
    content: '';
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; bottom: 3px;
    background: var(--text-secondary);
    border-radius: 50%;
    transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s var(--ease);
  }
  .toggle input:checked + .track {
    background: var(--card-accent, var(--accent));
  }
  .toggle input:checked + .track::before {
    transform: translateX(20px);
    background: #fff;
  }

  /* Buttons */
  .btn-save {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.55rem 1.35rem;
    background: var(--card-accent, var(--accent));
    color: var(--bg);
    border: none;
    border-radius: var(--radius-xs);
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: filter 0.15s var(--ease), transform 0.15s var(--ease);
  }
  .btn-save:hover:not(:disabled) {
    filter: brightness(1.15);
    transform: translateY(-1px);
  }
  .btn-save:active:not(:disabled) { transform: translateY(0); }
  .btn-save:disabled {
    opacity: 0.45;
    cursor: not-allowed;
  }
  .btn-save .spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Toast ── */
  .toast-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .toast {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.75rem 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.82rem;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    animation: toast-in 0.3s ease-out;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  .toast.success { border-color: rgba(74, 222, 128, 0.3); }
  .toast.error { border-color: rgba(248, 113, 113, 0.3); }
  .toast-icon { flex-shrink: 0; }
  .toast.success .toast-icon { color: var(--success); }
  .toast.error .toast-icon { color: var(--error); }
  @keyframes toast-in {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  .toast.leaving {
    animation: toast-out 0.25s ease-in forwards;
  }
  @keyframes toast-out {
    to { opacity: 0; transform: translateX(20px); }
  }

  /* ── Responsive ── */
  @media (max-width: 860px) {
    :root { --sidebar-w: 220px; }
    .main { padding: 2rem 2rem 3rem; }
    .field-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 640px) {
    :root { --sidebar-w: 0px; }
    .sidebar { display: none; }
    .main { margin-left: 0; padding: 2rem 1rem 3rem; }
    .field-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="accent-bar"></div>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <h1>Claude History Server</h1>
    <span class="badge">Control Panel</span>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section">Pages</div>
    <a class="nav-item disabled" style="--nav-color: #a78bfa">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
      </svg>
      Dashboard
      <span class="coming-soon">Soon</span>
    </a>

    <div class="nav-section">Settings</div>
    <a class="nav-item" href="#auth-card" data-nav="auth-card" style="--nav-color: var(--text-dim)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
      </svg>
      Authentication
    </a>
    <a class="nav-item" href="#heartbeat-card" data-nav="heartbeat-card" style="--nav-color: var(--accent)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
      </svg>
      Heartbeat
    </a>
    <a class="nav-item" href="#logging-card" data-nav="logging-card" style="--nav-color: var(--cyan)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
      </svg>
      Logging
    </a>
    <a class="nav-item" href="#security-card" data-nav="security-card" style="--nav-color: var(--rose)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      Security
    </a>
  </nav>

  <div class="sidebar-footer">
    <div class="server-status">
      <span class="pulse-dot" id="status-dot"></span>
      <span id="status-label">Checking…</span>
    </div>
  </div>
</aside>

<!-- Main content -->
<main class="main">
  <div class="main-inner">
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle">Configure your Claude History Server instance.</p>

    <!-- Authentication -->
    <section class="card" id="auth-card" style="--card-accent: var(--text-dim)">
      <div class="card-header">
        <div class="card-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
          </svg>
        </div>
        <div>
          <div class="auth-title-row">
            <h2>Authentication</h2>
            <span class="auth-dot" id="auth-dot"></span>
          </div>
          <p class="card-desc">API key for server access</p>
        </div>
      </div>
      <div class="card-body">
        <div class="field">
          <label for="apiKey">API Key</label>
          <div class="input-group">
            <input type="password" id="apiKey" class="mono-input" placeholder="Enter your API key" autocomplete="off">
            <button class="input-action" id="toggle-key" type="button" title="Toggle visibility">
              <svg id="eye-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div class="hint">Stored in browser localStorage. Required for saving settings.</div>
        </div>
      </div>
    </section>

    <!-- Heartbeat -->
    <section class="card config-card" id="heartbeat-card" style="--card-accent: var(--accent); --card-accent-soft: var(--accent-soft)">
      <div class="card-header">
        <div class="card-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
        </div>
        <div>
          <h2>Heartbeat</h2>
          <p class="card-desc">Automatic session health checks</p>
        </div>
      </div>
      <div class="card-body">
        <div class="field">
          <label>Status</label>
          <div class="toggle-field">
            <label class="toggle">
              <input type="checkbox" id="hb-enabled">
              <span class="track"></span>
            </label>
            <span class="toggle-label" onclick="document.getElementById('hb-enabled').click()">Enabled</span>
          </div>
        </div>
        <div class="hb-fields dimmed" id="hb-fields">
          <div class="field-grid">
            <div class="field">
              <label for="hb-interval">Interval (minutes)</label>
              <input type="number" id="hb-interval" min="1" step="1" value="60">
              <div class="hint">Minimum 1 min</div>
            </div>
            <div class="field">
              <label for="hb-maxitems">Max Items / Run</label>
              <input type="number" id="hb-maxitems" min="0" step="1" value="0">
              <div class="hint">0 = unlimited</div>
            </div>
          </div>
          <div class="field">
            <label for="hb-workdir">Working Directory</label>
            <input type="text" id="hb-workdir" class="mono-input" placeholder="/path/to/project">
            <div class="hint">Directory where Claude sessions run for heartbeat analysis.</div>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <button class="btn-save" id="hb-save">Save Changes</button>
      </div>
    </section>

    <!-- Logging -->
    <section class="card config-card" id="logging-card" style="--card-accent: var(--cyan); --card-accent-soft: var(--cyan-soft)">
      <div class="card-header">
        <div class="card-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
          </svg>
        </div>
        <div>
          <h2>Logging</h2>
          <p class="card-desc">HTTP request logging verbosity</p>
        </div>
      </div>
      <div class="card-body">
        <div class="field">
          <label for="log-level">Request Log Level</label>
          <select id="log-level">
            <option value="all">All requests</option>
            <option value="errors-only">Errors only (4xx / 5xx)</option>
            <option value="off">Off</option>
          </select>
          <div class="hint">Changes take effect immediately.</div>
        </div>
      </div>
      <div class="card-footer">
        <button class="btn-save" id="log-save">Save Changes</button>
      </div>
    </section>

    <!-- Security -->
    <section class="card config-card" id="security-card" style="--card-accent: var(--rose); --card-accent-soft: var(--rose-soft)">
      <div class="card-header">
        <div class="card-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
        </div>
        <div>
          <h2>Security</h2>
          <p class="card-desc">Session execution constraints</p>
        </div>
      </div>
      <div class="card-body">
        <div class="field">
          <label for="sec-alloweddirs">Allowed Working Directories</label>
          <textarea id="sec-alloweddirs" class="mono-input" rows="5" placeholder="/Users/you/Developer&#10;/tmp/safe-project"></textarea>
          <div class="hint">One directory per line. Sessions can only run in these directories and subdirectories. Leave empty to deny all.</div>
        </div>
      </div>
      <div class="card-footer">
        <button class="btn-save" id="sec-save">Save Changes</button>
      </div>
    </section>
  </div>
</main>

<div id="toast-container" class="toast-container"></div>

<script>
(function() {
  /* ── DOM refs ── */
  const apiKeyInput   = document.getElementById('apiKey');
  const toggleKeyBtn  = document.getElementById('toggle-key');
  const authDot       = document.getElementById('auth-dot');
  const statusDot     = document.getElementById('status-dot');
  const statusLabel   = document.getElementById('status-label');
  const hbEnabled     = document.getElementById('hb-enabled');
  const hbInterval    = document.getElementById('hb-interval');
  const hbWorkdir     = document.getElementById('hb-workdir');
  const hbMaxitems    = document.getElementById('hb-maxitems');
  const hbSave        = document.getElementById('hb-save');
  const logLevel      = document.getElementById('log-level');
  const logSave       = document.getElementById('log-save');
  const secDirs       = document.getElementById('sec-alloweddirs');
  const secSave       = document.getElementById('sec-save');
  const toastBox      = document.getElementById('toast-container');
  const configCards   = document.querySelectorAll('.config-card');
  const navItems      = document.querySelectorAll('.nav-item[data-nav]');

  /* ── Toast system ── */
  function toast(msg, type) {
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    const icon = type === 'success'
      ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>'
      : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
    el.innerHTML = '<span class="toast-icon">' + icon + '</span><span>' + msg + '</span>';
    toastBox.appendChild(el);
    setTimeout(function() {
      el.classList.add('leaving');
      el.addEventListener('animationend', function() { el.remove(); });
    }, 3000);
  }

  /* ── Card enable / disable ── */
  function setCardsEnabled(enabled) {
    configCards.forEach(function(card) {
      card.classList.toggle('disabled', !enabled);
      card.querySelectorAll('input, button, textarea, select').forEach(function(el) {
        el.disabled = !enabled;
      });
    });
  }
  setCardsEnabled(false);

  /* ── Health check ── */
  async function checkHealth() {
    try {
      const res = await fetch('/health');
      if (res.ok) {
        statusDot.className = 'pulse-dot connected';
        statusLabel.textContent = 'Connected';
      } else { throw 0; }
    } catch {
      statusDot.className = 'pulse-dot error';
      statusLabel.textContent = 'Disconnected';
    }
  }
  checkHealth();
  setInterval(checkHealth, 15000);

  /* ── Sidebar nav: highlight active section on scroll ── */
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        navItems.forEach(function(n) { n.classList.remove('active'); });
        var match = document.querySelector('.nav-item[data-nav="' + entry.target.id + '"]');
        if (match) match.classList.add('active');
      }
    });
  }, { rootMargin: '-20% 0px -60% 0px' });
  document.querySelectorAll('.card[id]').forEach(function(card) { observer.observe(card); });

  /* Smooth scroll on nav click */
  navItems.forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      var target = document.getElementById(item.dataset.nav);
      if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  /* ── Heartbeat toggle dims fields ── */
  var hbFields = document.getElementById('hb-fields');
  function syncHbFields() {
    hbFields.classList.toggle('dimmed', !hbEnabled.checked);
  }
  hbEnabled.addEventListener('change', syncHbFields);

  /* ── API key ── */
  apiKeyInput.value = localStorage.getItem('adminApiKey') || '';
  var keyTimer = null;
  apiKeyInput.addEventListener('input', function() {
    localStorage.setItem('adminApiKey', apiKeyInput.value);
    clearTimeout(keyTimer);
    keyTimer = setTimeout(loadConfig, 400);
  });

  toggleKeyBtn.addEventListener('click', function() {
    var isPassword = apiKeyInput.type === 'password';
    apiKeyInput.type = isPassword ? 'text' : 'password';
    document.getElementById('eye-icon').innerHTML = isPassword
      ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'
      : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  });

  /* ── Helpers ── */
  function headers() {
    var h = { 'Content-Type': 'application/json' };
    var k = apiKeyInput.value.trim();
    if (k) h['X-API-Key'] = k;
    return h;
  }

  function btnLoading(btn, loading) {
    if (loading) {
      btn.disabled = true;
      btn.dataset.text = btn.textContent;
      btn.innerHTML = '<span class="spinner"></span>Saving…';
    } else {
      btn.disabled = false;
      btn.textContent = btn.dataset.text || 'Save Changes';
    }
  }

  /* ── Load config ── */
  async function loadConfig() {
    authDot.className = 'auth-dot loading';
    try {
      var res = await fetch('/api/config', { headers: headers() });
      if (!res.ok) {
        if (res.status === 401) {
          authDot.className = 'auth-dot fail';
          setCardsEnabled(false);
          return;
        }
        throw new Error('HTTP ' + res.status);
      }
      var data = await res.json();

      var hb = data.heartbeat || {};
      hbEnabled.checked    = hb.enabled ?? false;
      hbInterval.value     = hb.intervalMs ? Math.round(hb.intervalMs / 60000) : 60;
      hbWorkdir.value      = hb.workingDirectory || '';
      hbMaxitems.value     = hb.maxItems ?? 0;

      logLevel.value = (data.logging || {}).requestLogLevel || 'all';
      secDirs.value = ((data.security || {}).allowedWorkingDirs || []).join('\n');

      authDot.className = 'auth-dot ok';
      setCardsEnabled(true);
      syncHbFields();
    } catch (err) {
      authDot.className = 'auth-dot fail';
      setCardsEnabled(false);
      toast('Failed to load config: ' + err.message, 'error');
    }
  }

  /* ── Save: heartbeat ── */
  hbSave.addEventListener('click', async function() {
    btnLoading(hbSave, true);
    try {
      var body = {
        enabled: hbEnabled.checked,
        intervalMs: Math.max(1, parseInt(hbInterval.value) || 60) * 60000,
        workingDirectory: hbWorkdir.value,
        maxItems: Math.max(0, parseInt(hbMaxitems.value) || 0),
      };
      var res = await fetch('/api/config/heartbeat', { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'HTTP ' + res.status);
      toast('Heartbeat settings saved', 'success');
    } catch (err) {
      toast(err.message, 'error');
    } finally {
      btnLoading(hbSave, false);
    }
  });

  /* ── Save: logging ── */
  logSave.addEventListener('click', async function() {
    btnLoading(logSave, true);
    try {
      var body = { requestLogLevel: logLevel.value };
      var res = await fetch('/api/config/logging', { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'HTTP ' + res.status);
      toast('Logging settings saved', 'success');
    } catch (err) {
      toast(err.message, 'error');
    } finally {
      btnLoading(logSave, false);
    }
  });

  /* ── Save: security ── */
  secSave.addEventListener('click', async function() {
    btnLoading(secSave, true);
    try {
      var lines = secDirs.value.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l.length > 0; });
      var body = { allowedWorkingDirs: lines };
      var res = await fetch('/api/config/security', { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'HTTP ' + res.status);
      toast('Security settings saved', 'success');
    } catch (err) {
      toast(err.message, 'error');
    } finally {
      btnLoading(secSave, false);
    }
  });

  /* ── Init ── */
  loadConfig();
})();
</script>
</body>
</html>
