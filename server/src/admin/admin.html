<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude History Server - Admin</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    color: #333;
    line-height: 1.5;
    padding: 2rem 1rem;
  }
  .container { max-width: 640px; margin: 0 auto; }
  h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
  .subtitle { color: #666; font-size: 0.875rem; margin-bottom: 1.5rem; }
  .card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
  }
  .card h2 { font-size: 1.1rem; margin-bottom: 1rem; }
  .field { margin-bottom: 1rem; }
  .field label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
  .field .hint { font-size: 0.75rem; color: #888; margin-top: 0.15rem; }
  input[type="text"], input[type="number"], input[type="password"] {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.875rem;
    font-family: inherit;
  }
  input:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.15); }
  .toggle-row { display: flex; align-items: center; gap: 0.75rem; }
  .toggle {
    position: relative; width: 44px; height: 24px; flex-shrink: 0;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle .slider {
    position: absolute; inset: 0; background: #ccc; border-radius: 24px;
    cursor: pointer; transition: background 0.2s;
  }
  .toggle .slider::before {
    content: ''; position: absolute; width: 18px; height: 18px;
    left: 3px; bottom: 3px; background: #fff; border-radius: 50%;
    transition: transform 0.2s;
  }
  .toggle input:checked + .slider { background: #34c759; }
  .toggle input:checked + .slider::before { transform: translateX(20px); }
  .actions { display: flex; align-items: center; gap: 0.75rem; margin-top: 1.25rem; }
  button {
    padding: 0.5rem 1.25rem;
    border: none; border-radius: 6px;
    font-size: 0.875rem; font-weight: 500;
    cursor: pointer; transition: background 0.15s;
  }
  .btn-primary { background: #007aff; color: #fff; }
  .btn-primary:hover { background: #0066d6; }
  .btn-primary:disabled { background: #99c9ff; cursor: not-allowed; }
  .status { font-size: 0.8rem; }
  .status.success { color: #34c759; }
  .status.error { color: #ff3b30; }
  .status.loading { color: #888; }
</style>
</head>
<body>
<div class="container">
  <h1>Claude History Server</h1>
  <p class="subtitle">Control Panel</p>

  <!-- API Key -->
  <div class="card">
    <h2>Authentication</h2>
    <div class="field">
      <label for="apiKey">API Key</label>
      <input type="password" id="apiKey" placeholder="Enter your API key">
      <div class="hint">Stored in browser localStorage. Required for saving settings.</div>
    </div>
  </div>

  <!-- Heartbeat Configuration -->
  <div class="card" id="heartbeat-card">
    <h2>Heartbeat Configuration</h2>
    <div class="field">
      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" id="hb-enabled">
          <span class="slider"></span>
        </label>
        <label for="hb-enabled">Enabled</label>
      </div>
    </div>
    <div class="field">
      <label for="hb-interval">Interval (minutes)</label>
      <input type="number" id="hb-interval" min="1" step="1" value="60">
      <div class="hint">Minimum 1 minute. Heartbeat checks for new work items at this interval.</div>
    </div>
    <div class="field">
      <label for="hb-workdir">Working Directory</label>
      <input type="text" id="hb-workdir" placeholder="/path/to/project">
      <div class="hint">Directory where Claude sessions run for heartbeat analysis.</div>
    </div>
    <div class="field">
      <label for="hb-maxitems">Max Items per Run</label>
      <input type="number" id="hb-maxitems" min="0" step="1" value="0">
      <div class="hint">Maximum work items to process per heartbeat. 0 = unlimited.</div>
    </div>
    <div class="actions">
      <button class="btn-primary" id="hb-save">Save</button>
      <span class="status" id="hb-status"></span>
    </div>
  </div>
</div>

<script>
(function() {
  const apiKeyInput = document.getElementById('apiKey');
  const hbEnabled = document.getElementById('hb-enabled');
  const hbInterval = document.getElementById('hb-interval');
  const hbWorkdir = document.getElementById('hb-workdir');
  const hbMaxitems = document.getElementById('hb-maxitems');
  const hbSave = document.getElementById('hb-save');
  const hbStatus = document.getElementById('hb-status');

  const heartbeatCard = document.getElementById('heartbeat-card');
  let configLoaded = false;

  function setCardEnabled(enabled) {
    const inputs = heartbeatCard.querySelectorAll('input, button');
    inputs.forEach(el => { if (el.id !== 'apiKey') el.disabled = !enabled; });
    heartbeatCard.style.opacity = enabled ? '1' : '0.5';
  }

  // Start with card disabled until config loads
  setCardEnabled(false);

  // Persist API key in localStorage
  apiKeyInput.value = localStorage.getItem('adminApiKey') || '';

  let reloadTimer = null;
  apiKeyInput.addEventListener('input', () => {
    localStorage.setItem('adminApiKey', apiKeyInput.value);
    clearTimeout(reloadTimer);
    reloadTimer = setTimeout(loadConfig, 400);
  });

  function getHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    const key = apiKeyInput.value.trim();
    if (key) headers['X-API-Key'] = key;
    return headers;
  }

  function showStatus(el, msg, type) {
    el.textContent = msg;
    el.className = 'status ' + type;
    if (type === 'success') {
      setTimeout(() => { el.textContent = ''; el.className = 'status'; }, 3000);
    }
  }

  // Load current config
  async function loadConfig() {
    showStatus(hbStatus, 'Loading...', 'loading');
    try {
      const res = await fetch('/api/config', { headers: getHeaders() });
      if (!res.ok) {
        if (res.status === 401) {
          configLoaded = false;
          setCardEnabled(false);
          showStatus(hbStatus, 'Enter a valid API key to load settings', 'error');
          return;
        }
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      const hb = data.heartbeat || {};
      hbEnabled.checked = hb.enabled ?? false;
      hbInterval.value = hb.intervalMs ? Math.round(hb.intervalMs / 60000) : 60;
      hbWorkdir.value = hb.workingDirectory || '';
      hbMaxitems.value = hb.maxItems ?? 0;
      configLoaded = true;
      setCardEnabled(true);
      showStatus(hbStatus, '', '');
    } catch (err) {
      configLoaded = false;
      setCardEnabled(false);
      showStatus(hbStatus, 'Failed to load config: ' + err.message, 'error');
    }
  }

  // Save heartbeat section
  hbSave.addEventListener('click', async () => {
    hbSave.disabled = true;
    showStatus(hbStatus, 'Saving...', 'loading');
    try {
      const body = {
        enabled: hbEnabled.checked,
        intervalMs: Math.max(1, parseInt(hbInterval.value) || 60) * 60000,
        workingDirectory: hbWorkdir.value,
        maxItems: Math.max(0, parseInt(hbMaxitems.value) || 0),
      };
      const res = await fetch('/api/config/heartbeat', {
        method: 'PUT',
        headers: getHeaders(),
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      showStatus(hbStatus, 'Saved', 'success');
    } catch (err) {
      showStatus(hbStatus, err.message, 'error');
    } finally {
      hbSave.disabled = false;
    }
  });

  loadConfig();
})();
</script>
</body>
</html>
